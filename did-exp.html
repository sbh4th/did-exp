<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sam Harper">
<meta name="dcterms.date" content="2023-05-24">

<title>Difference-in-Differences with Heterogenous Treatment Effects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="did-exp_files/libs/clipboard/clipboard.min.js"></script>
<script src="did-exp_files/libs/quarto-html/quarto.js"></script>
<script src="did-exp_files/libs/quarto-html/popper.min.js"></script>
<script src="did-exp_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="did-exp_files/libs/quarto-html/anchor.min.js"></script>
<link href="did-exp_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="did-exp_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="did-exp_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="did-exp_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="did-exp_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="did-exp_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="did-exp_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Difference-in-Differences with Heterogenous Treatment Effects</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sam Harper </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 24, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="setup" class="level1">
<h1>Setup</h1>
<p>In this document we aim to provide an overview of the issues and methods for evaluating policy impacts in the context of heterogeneous treatments and staggered treatments.</p>
<section id="simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="simulated-data">Simulated data</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">394</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># unit fixed effects (unobserved heterogeneity)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>unit <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate clusters</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">unit_fe =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, state<span class="sc">/</span><span class="dv">10</span>, <span class="dv">1</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate instantaneous treatment effect</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mu = rnorm(nobs, true_mu, 0.2)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="dv">2</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># year fixed effects (first part)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2020</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_fe =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(year), <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Put the clusters into treatment groups</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>treat_taus <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample the clusters randomly</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">30</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># place the randomly sampled states into 1\{t \ge g \}G_g</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_year =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">2014</span>, <span class="dv">2016</span>, <span class="dv">2018</span>), <span class="dv">10</span>))</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># make main dataset</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># full interaction of unit X year </span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="at">year =</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2020</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., unit) <span class="sc">%&gt;%</span> </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., year) <span class="sc">%&gt;%</span> </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., treat_taus) <span class="sc">%&gt;%</span> </span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make error term and get treatment indicators and treatment effects</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also get cohort specific trends (modify time FE)</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>         <span class="at">treat =</span> <span class="fu">ifelse</span>((year <span class="sc">&gt;=</span> </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>           cohort_year)<span class="sc">*</span>(cohort_year <span class="sc">!=</span> <span class="dv">2018</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>         <span class="co"># treatment effect = 1 if 2016, 2 if 2014, annually</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">mu =</span> <span class="fu">ifelse</span>(cohort_year<span class="sc">==</span><span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>         <span class="at">tau =</span> <span class="fu">ifelse</span>(treat <span class="sc">==</span> <span class="dv">1</span>, mu, <span class="dv">0</span>),</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">year_fe =</span> year_fe <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>(year <span class="sc">-</span> cohort_year)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate cumulative treatment effects</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span> </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tau_cum =</span> <span class="fu">cumsum</span>(tau)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the dependent variable</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> (<span class="dv">2020</span> <span class="sc">-</span> cohort_year) <span class="sc">+</span> </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>           unit_fe <span class="sc">+</span> year_fe <span class="sc">+</span> tau_cum <span class="sc">+</span> error) <span class="sc">%&gt;%</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relabel 2018 cohort as never-treated</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_year =</span> <span class="fu">ifelse</span>(cohort_year <span class="sc">==</span> <span class="dv">2018</span>, <span class="cn">Inf</span>, cohort_year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For this example we will use a simulated example.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> For the time being, we are ignoring covariates.</p>
<p>We are simulating a staggered treatment setup where 30 ‘clusters’, which could be countries, villages, states, etc., but in this case we will use states (<span class="math inline">\(state = \{1,2,\dots,30\}\)</span>), which are randomly assigned into 3 treatment groups depending on the treatment starting year (2014, 2016, never treated). We denote the treatment starting period as <span class="math inline">\(g\)</span> that encompasses the 3 groups (i.e., <span class="math inline">\(g \in \{ 2014, 2016, \text{-Inf}\}\)</span>), where <span class="math inline">\(\text{-Inf}\)</span> indicates the never treated group (following <span class="citation" data-cites="Callaway:2021aa">Callaway and Sant’Anna (<a href="#ref-Callaway:2021aa" role="doc-biblioref">2021</a>)</span> here such that <span class="math inline">\(g = \infty\)</span> for a never-treated group). We have 1000 units spread out over the 30 clusters, which could be individuals, schools, hospitals, or some other smaller units <span class="math inline">\(i\)</span>, which are randomly assigned to one of the 30 states. Let <span class="math inline">\(G_i\)</span> indicates the group/cohort unit <span class="math inline">\(i\)</span> belongs to, i.e., <span class="math inline">\(G \subseteq \{ 2014, 2016, \infty\}\)</span>.</p>
<p>The data generating process (DGP) for the outcome <span class="math inline">\(Y\)</span> is: <span class="math display">\[Y_{it} = (2020-g) + \alpha_i + \beta_t + \tau_{it} + \epsilon_{it}\]</span> where <span class="math inline">\(\alpha_i\)</span> are unit (i.e., cluster) fixed effects drawn from <span class="math inline">\(\sim N(\mu_{state}, 1)\)</span> with state-specific mean <span class="math inline">\(\mu_{state} = state/10\)</span>, <span class="math inline">\(\beta_t\)</span> are time fixed effects (cohort-specific parallel time-trends) generated as <span class="math display">\[\beta_t = 0.5 * (t - g) + \epsilon^{time FE}_t, \]</span> with <span class="math inline">\(\epsilon^{time FE}_t \sim N(0, 1)\)</span>, <span class="math inline">\(\epsilon_{i,t} \sim N(0,2)\)</span> is an idiosyncratic error term. The <span class="math inline">\(\tau_{i,t}\)</span> are the (instantaneous) unit-specific treatment effects at time <span class="math inline">\(t\)</span> generated as <span class="math display">\[ \tau_{it} = \mu_g \times (t - g + 1)\times 1\{t \ge g \}1\{g\not=\infty \},\]</span> where <span class="math inline">\(t\)</span> and <span class="math inline">\(g\)</span> are defined as above and <span class="math inline">\(1\{\}\)</span> is a logical operator. We set <span class="math inline">\(\mu_{2014} = 2\)</span>, and <span class="math inline">\(\mu_{2016} = 1\)</span>.</p>
<p>So, for example, in 2014 when <span class="math inline">\(G_{2014}\)</span> is first treated, <span class="math inline">\((t - g + 1)=1\)</span> and the treatment effect is 2. This setup implies heterogeneity: for the group that started treatment in 2014, its average treatment effects evolves with time since first treatment as <span class="math inline">\(2,4,6,\dots\)</span>. For the group that started treatment in 2016 the average treatment effect evolves with elapsed time as <span class="math inline">\(1,2,3,\dots\)</span>. The treatment effect is zero for the “never-treated” cohort (<span class="math inline">\(g=\infty\)</span>). In this case the early-treated group (<span class="math inline">\(g=2014\)</span>) benefits more than the later treated group.</p>
<p>Given that each group has same size (on average), the true average treatment effect dynamic across treated groups is <span class="math inline">\((2+1)/2 = 1.5\)</span> at the time a unit is treated, <span class="math inline">\(2 \times (2+1)/2 = 3\)</span> in the first period after treatment started, etc.</p>
<p>A random sample of 10 rows of the data are shown below:</p>
<div class="cell" data-hash="did-exp_cache/html/simtab_32d3abe38d717d7d4444d1c83c8fc52a">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="fu">sample_n</span>(d,<span class="dv">10</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(ds, <span class="at">caption =</span> <span class="st">"10 rows of simulated data"</span>, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>10 rows of simulated data</caption>
 <thead>
  <tr>
   <th style="text-align:right;"> unit </th>
   <th style="text-align:right;"> year </th>
   <th style="text-align:right;"> state </th>
   <th style="text-align:right;"> unit_fe </th>
   <th style="text-align:right;"> mu </th>
   <th style="text-align:right;"> year_fe </th>
   <th style="text-align:right;"> cohort_year </th>
   <th style="text-align:right;"> error </th>
   <th style="text-align:right;"> treat </th>
   <th style="text-align:right;"> tau </th>
   <th style="text-align:right;"> tau_cum </th>
   <th style="text-align:right;"> y </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 467 </td>
   <td style="text-align:right;"> 2019 </td>
   <td style="text-align:right;"> 20 </td>
   <td style="text-align:right;"> 2.262 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 1.962 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> -3.628 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 12 </td>
   <td style="text-align:right;"> 18.596 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 656 </td>
   <td style="text-align:right;"> 2016 </td>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 1.066 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 0.403 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> -2.276 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 11.192 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 696 </td>
   <td style="text-align:right;"> 2012 </td>
   <td style="text-align:right;"> 28 </td>
   <td style="text-align:right;"> 2.942 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> -0.280 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> 1.604 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 10.266 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 774 </td>
   <td style="text-align:right;"> 2017 </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> -1.023 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.543 </td>
   <td style="text-align:right;"> 2016 </td>
   <td style="text-align:right;"> 0.337 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 5.857 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 322 </td>
   <td style="text-align:right;"> 2012 </td>
   <td style="text-align:right;"> 12 </td>
   <td style="text-align:right;"> -0.865 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> -2.280 </td>
   <td style="text-align:right;"> Inf </td>
   <td style="text-align:right;"> 0.170 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> -0.974 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 355 </td>
   <td style="text-align:right;"> 2018 </td>
   <td style="text-align:right;"> 21 </td>
   <td style="text-align:right;"> 2.551 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 2.485 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> -0.330 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 20.706 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 736 </td>
   <td style="text-align:right;"> 2017 </td>
   <td style="text-align:right;"> 22 </td>
   <td style="text-align:right;"> 3.307 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> -0.457 </td>
   <td style="text-align:right;"> Inf </td>
   <td style="text-align:right;"> -2.127 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 2.722 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 523 </td>
   <td style="text-align:right;"> 2016 </td>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 1.107 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> -0.597 </td>
   <td style="text-align:right;"> 2016 </td>
   <td style="text-align:right;"> -3.021 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2.488 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 715 </td>
   <td style="text-align:right;"> 2013 </td>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 1.833 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> -1.649 </td>
   <td style="text-align:right;"> 2016 </td>
   <td style="text-align:right;"> 4.471 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 8.655 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 720 </td>
   <td style="text-align:right;"> 2011 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 0.845 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> -3.563 </td>
   <td style="text-align:right;"> Inf </td>
   <td style="text-align:right;"> 0.830 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0.112 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
<section id="plot-of-simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="plot-of-simulated-data">Plot of simulated data</h2>
<p>Below we show the evolution of <span class="math inline">\(y\)</span> over time for the 3 treatment groups (2014, 2016, untreated). The vertical lines indicate the time of treatment, i.e.&nbsp;<span class="math inline">\(g=t\)</span> for each treated group, and the bold lines show the average evolution of the outcome for each treatment group.</p>
<div class="cell" data-hash="did-exp_cache/html/plotsim_ff5dff9cc222dbe7c8dc7080a392993c">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_blank</span>()))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y, <span class="at">group =</span> unit)) <span class="sc">+</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cohort_year, year) <span class="sc">%&gt;%</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">mean</span>(y)),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y, <span class="at">group =</span> <span class="fu">factor</span>(cohort_year),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(cohort_year)), <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Y"</span>,  <span class="at">color =</span> <span class="st">"Treatment group   "</span>) <span class="sc">+</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2012</span>, <span class="dv">2014</span>, <span class="dv">2016</span>, <span class="dv">2018</span>, <span class="dv">2020</span>)) <span class="sc">+</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2014</span>, <span class="at">color =</span> <span class="st">'#E41A1C'</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2016</span>, <span class="at">color =</span> <span class="st">'#377EB8'</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">'Set1'</span>) <span class="sc">+</span> </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">#legend.title = element_blank(), </span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"2014"</span>, <span class="st">"2016"</span>, <span class="st">"Never-treated"</span>),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#E41A1C"</span>, <span class="st">"#377EB8"</span>, <span class="st">"#4DAF4A"</span>)) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Simulated data with heterogeneous treatment effect dynamics across cohorts </span><span class="sc">\n</span><span class="st"> and with a never-treated group"</span>)<span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>plot </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="did-exp_files/figure-html/plotsim-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="estimating-treatment-effects" class="level1">
<h1>Estimating treatment effects</h1>
<p>Next we show various ways of estimating the treatment effects, starting with the standard two-way fixed effects (TWFE) that has been standard in many diff-in-diffs analyses.</p>
<section id="twfe-average" class="level2">
<h2 class="anchored" data-anchor-id="twfe-average">TWFE (average)</h2>
<p>The basic model is estimated as:</p>
<p><span class="math display">\[Y_{it} = \alpha_i + \beta_t + \gamma D_{it} + \varepsilon_{it}\]</span> where <span class="math inline">\(D_{i,t}\)</span> is a time-varying treatment dummy variable that takes value one if a unit <span class="math inline">\(i\)</span> is treated at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(\alpha_{i}\)</span> and <span class="math inline">\(\beta_{t}\)</span> are fixed effects for unit and time, respectively. We implement this below using the <code>fixest</code> package and cluster the standard errors at the state level.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDummies)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="twfe-dynamic" class="level2">
<h2 class="anchored" data-anchor-id="twfe-dynamic">TWFE (dynamic)</h2>
<p>Many analyses using TWFE also typically implement an ‘event study’ type analysis as a robustness check, both to see how the treatment effect may evolve over time in the post period and to see whether there may be some evidence of non-parallel trends in the pre-treatment period. We can implement the event-study type model as: <span class="math display">\[Y_{it} = \alpha_i + \beta_t + \sum_{k\neq-1} \gamma_{k} D_{it} + \varepsilon_{it}\]</span> where <span class="math inline">\(k\)</span> indicates time indicators relative to first treatment (i.e., <span class="math inline">\(k=-2\)</span> means 2 periods prior to treatment) and <span class="math inline">\(\gamma_{k}\)</span> are the coefficients on the relative time indicators. To avoid collinearity we exclude one period, which is typically the period just before first treatment (<span class="math inline">\(k=-1\)</span>).</p>
<p>Below is a table showing the estimated effects from the TWFE and event-study models. The overall average estimate from the traditional TWFE model is 3.5, which we know isn’t correct, since the average effect should be something closer to <span class="math inline">\(\frac{1}{7}\sum_{t=1}^{7} t*(2+1)/2 = 6\)</span></p>
<div class="cell" data-hash="did-exp_cache/html/es_3946f47a5b2030ae1eb3d3916e6185eb">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate TWFE</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>twfe <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># first make dummy columns for relative time</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make dummies</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rel_year =</span> year <span class="sc">-</span> cohort_year) <span class="sc">%&gt;%</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dummy_cols</span>(<span class="at">select_columns =</span> <span class="st">"rel_year"</span>) </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the model</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>twfe_event <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="st">`</span><span class="at">rel_year_-5</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-4</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-3</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">rel_year_-2</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_0</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_1</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rel_year_2</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_3</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_4</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rel_year_5</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_6</span><span class="st">`</span> <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>rename_rt <span class="ot">&lt;-</span> <span class="cf">function</span>(old_names) {</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  new_names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"rel_year_"</span>, <span class="st">"Relative time: "</span>, old_names)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(new_names, old_names)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"TWFE"</span> <span class="ot">=</span> twfe, </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"TWFE:Event study"</span> <span class="ot">=</span> twfe_event),</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_rename =</span> rename_rt,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'DF|Deviance|R2|AIC|BIC|Log.Lik|ICC|RMSE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> TWFE </th>
   <th style="text-align:center;"> TWFE:Event study </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> treat </td>
   <td style="text-align:center;"> 3.697 </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.665) </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: -5 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 1.897 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.332) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: -4 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 1.739 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.281) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: -3 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.654 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.199) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: -2 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.508 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.152) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 0 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 1.360 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.134) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 1 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 3.018 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.212) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 2 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 4.358 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.275) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 3 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 6.537 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.291) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 4 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 8.148 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.391) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 5 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 11.950 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.260) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Relative time: 6 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 14.302 </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.386) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;"> 10000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Std.Errors </td>
   <td style="text-align:center;"> by: state </td>
   <td style="text-align:center;"> by: state </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: state </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: year </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>How well do the event study coefficients map on to our true estimates from the DGP? Below we show a plot of the true effects based on the simulated data, as well as the estimates from the event study. The answer is: okay? The TWFE estimates are sensible in the post period, but they also suggest some evidence for non-parallel trends in the pre-period, which, in the before times, might lead one to think the parallel trends assumption is violated, which we know is not the case here since we forced the model to be parallel in the pre period [some text on intuition for this would be helpful here].<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell" data-hash="did-exp_cache/html/esp_3334a2fd1a6b1ca6341d4c9c1afbd2c8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of estimates</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pt <span class="ot">&lt;-</span> <span class="fu">get_estimates</span>(twfe_event) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">t =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">0</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.low =</span> <span class="dv">0</span>, <span class="at">conf.high =</span> <span class="dv">0</span>, <span class="at">term =</span> <span class="st">"rel_year_-1"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">true_tau =</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> t <span class="sc">&lt;</span> <span class="dv">5</span>, ((t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.5</span>), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(t <span class="sc">&gt;</span> <span class="dv">4</span>, (t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">0</span>)))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True Effect"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Estimated Effect"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>plot_es <span class="ot">&lt;-</span> pt <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate)) <span class="sc">+</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">'Estimated Effect'</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high), </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau, <span class="at">color =</span> <span class="st">'True Effect'</span>), </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Relative Time"</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"TWFE event-study regression estimates"</span>) <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_blank</span>())</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>plot_es</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="did-exp_files/figure-html/esp-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="callaway-santanna" class="level2">
<h2 class="anchored" data-anchor-id="callaway-santanna">Callaway-Sant’Anna</h2>
<p>To avoid the problems with the TWFE specification above, we can instead use the approach recently developed by <span class="citation" data-cites="Callaway:2021aa">Callaway and Sant’Anna (<a href="#ref-Callaway:2021aa" role="doc-biblioref">2021</a>)</span> that estimates the average treatment effect on the treated (<span class="math inline">\(ATT\)</span>) for each treated group <span class="math inline">\(g\)</span> at each time <span class="math inline">\(t\)</span>, i.e., <span class="math inline">\(ATT(g,t)\)</span>, where groups are defined according to when they were first treated. The group-time specific estimates of each <span class="math inline">\(ATT(g,t)\)</span> are estimated via regression on <em>subsets</em> of the data for each group and time periods covering pre- and post-intervention, using the following specification:</p>
<p><span class="math display">\[Y_{it} = \beta_{0}^{gt} + \beta_{1}^{gt}G + \beta_{2}^{gt}T + \beta_{3}^{gt}(G\times T) + \varepsilon^{gt} \]</span></p>
<p>where <span class="math inline">\(G\)</span> and <span class="math inline">\(T\)</span> refer to indicators for group and time period and <span class="math inline">\(\beta_{3}^{gt}\)</span> is the <span class="math inline">\(ATT(g,t)\)</span> for each group at a given time. Treated groups are compared to not yet treated groups to estimate group-time specific <span class="math inline">\(ATTs\)</span> , which can be combined to estimate the overall effect of the intervention, as well as dynamic treatment effects.</p>
<p>The table below compares the estimates from the TWFE model to ‘simple’ aggregate estimate from the CS model. As before, we know that the ‘truth’ here should be something like an average <span class="math inline">\(ATT\)</span> of 6. The TWFE estimate is wrong and biased downwards to around 3.5, where as the CS estimate is 5.9, about what it should be.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Callaway-Sant'Anna</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cs <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">"y"</span>, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">idname =</span> <span class="st">"unit"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gname =</span> <span class="st">"cohort_year"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control_group=</span> <span class="st">"notyettreated"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">bstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">clustervars =</span> <span class="st">"state"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">print_details =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>cs_simple <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"simple"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>cs_event <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>ti <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">"treat"</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> cs_simple<span class="sc">$</span>overall.att,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> cs_simple<span class="sc">$</span>overall.se)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>gl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>cs_avg <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti, <span class="at">glance =</span> gl)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(cs_avg) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"TWFE"</span> <span class="ot">=</span> twfe, <span class="st">"Callway-Sant'Anna"</span> <span class="ot">=</span> cs_avg),</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> TWFE </th>
   <th style="text-align:center;"> Callway-Sant'Anna </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> treat </td>
   <td style="text-align:center;"> 3.697 </td>
   <td style="text-align:center;"> 6.069 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.665) </td>
   <td style="text-align:center;"> (0.500) </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Estimating each group-time ATT in the CS way also allows several different ways of aggregating ATTs, depending on the question at hand. Above we showed the ‘simple’ average ATT, but it is also possible to look at dynamic trends or estimates for each separate treated cohort:</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Dynamic</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Group</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Calendar</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cs_event <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Dynamic"</span> <span class="ot">=</span> cs_event),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> CS: Dynamic </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(-4) </td>
   <td style="text-align:center;"> −0.082 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.213) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(-3) </td>
   <td style="text-align:center;"> 0.084 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.221) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(-2) </td>
   <td style="text-align:center;"> −0.005 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.158) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(-1) </td>
   <td style="text-align:center;"> −0.062 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.133) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(0) </td>
   <td style="text-align:center;"> 1.541 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.157) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(1) </td>
   <td style="text-align:center;"> 3.286 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.283) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2) </td>
   <td style="text-align:center;"> 4.633 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.338) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(3) </td>
   <td style="text-align:center;"> 6.197 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.425) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(4) </td>
   <td style="text-align:center;"> 7.616 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.533) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(5) </td>
   <td style="text-align:center;"> 11.796 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.182) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(6) </td>
   <td style="text-align:center;"> 13.809 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.210) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cs_group <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"group"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Group"</span> <span class="ot">=</span> cs_group),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> CS: Group </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(Average) </td>
   <td style="text-align:center;"> 5.688 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.129) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014) </td>
   <td style="text-align:center;"> 7.886 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.169) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016) </td>
   <td style="text-align:center;"> 3.255 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.166) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cs_cal <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"calendar"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Calendar"</span> <span class="ot">=</span> cs_cal),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> CS: Calendar </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(2014) </td>
   <td style="text-align:center;"> 1.747 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.214) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2015) </td>
   <td style="text-align:center;"> 4.195 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.252) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016) </td>
   <td style="text-align:center;"> 3.758 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.536) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2017) </td>
   <td style="text-align:center;"> 5.239 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.644) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2018) </td>
   <td style="text-align:center;"> 6.635 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.760) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2019) </td>
   <td style="text-align:center;"> 8.238 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.844) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2020) </td>
   <td style="text-align:center;"> 9.733 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.972) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
<p>From the “Group” estimates you can see that the average treatment effect for cohort first treated in 2014 is 8, whereas the effect for the cohort first treated in 2016 is around 2.6. The average reported here is different than the simple average above because it is the average effect of the two groups, rather than the simple average. The ‘calendar’ estimates are average for each time <span class="math inline">\(t\)</span> in the post-treatment period, which is different than the ‘dynamic’ effects, which are averages by time since first treated.</p>
<p>Let’s also just look and see at how our ‘dynamic’ estimates using CS compare to the truth:</p>
<div class="cell" data-hash="did-exp_cache/html/escs_db6cfaf06af6bf3335372e222ea64c4c">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of estimates</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ptcs <span class="ot">&lt;-</span> <span class="fu">get_estimates</span>(cs_event) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span><span class="sc">:-</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">true_tau =</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> t <span class="sc">&lt;</span> <span class="dv">5</span>, ((t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.5</span>), </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(t <span class="sc">&gt;</span> <span class="dv">4</span>, (t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">0</span>)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True Effect"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Estimated Effect"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plot_escs <span class="ot">&lt;-</span> ptcs <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate)) <span class="sc">+</span> </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">'Estimated Effect'</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high), </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau, <span class="at">color =</span> <span class="st">'True Effect'</span>), </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Relative Time"</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"CS event-study regression estimates"</span>) <span class="sc">+</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_blank</span>())</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>plot_escs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="did-exp_files/figure-html/escs-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These estimates look good, with no evidence of non-parallel trends in the pre-intervention period.</p>
</section>
<section id="extended-twfe" class="level2">
<h2 class="anchored" data-anchor-id="extended-twfe">‘Extended’ TWFE</h2>
<p>In a recent paper <span class="citation" data-cites="Wooldridge:2021aa">Wooldridge (<a href="#ref-Wooldridge:2021aa" role="doc-biblioref">2021</a>)</span> demonstrated that the issue we saw with the TWFE model above is not a problem with the TWFE model <em>per se</em>, only the way that it is specified. In particular, he notes that one can recover nearly identical <span class="math inline">\(ATT(g,t)\)</span> estimates from the linear TWFE model by including a set of interactive fixed effects between treated cohorts and time since treatment. This idea has been referred to as ‘extended’ TWFE, and basically amounts to interacting a time-varying treatment indicator with both the cohort-year indicators and each time period. He uses somewhat different terminology that we will try to adopt here, such that the time-varying treatment indicator is <span class="math inline">\(w_{it}\)</span>, cohort dummies indicating treatment at specific times <span class="math inline">\(r\)</span> since the time <span class="math inline">\(q\)</span> the first group is treated, i.e., <span class="math inline">\(d_{r}\)</span> and time period dummies <span class="math inline">\(fs_{t}\)</span> for every possible period <span class="math inline">\(s\)</span> after the first cohort is treated. Putting this together the ETWFE model ends up looking something like this:</p>
<p><span class="math display">\[Y_{it} = \alpha + \sum_{r=q}^{T} \beta_{r} d_{r} + \sum_{s=r}^{T} \gamma_{s} fs_{t}+ \sum_{r=q}^{T} \sum_{s=r}^{T} \tau_{rt} (d_{r} \times fs_{t}) + \varepsilon_{it}\]</span> Effectively, we are saturating the regression with interactions between treated cohorts and time, such that the <span class="math inline">\(\tau_{rt}\)</span> are estimates of each group-time ATT. Absent constraints this leads to obvious issues of collinearity. Wooldridge notes in his paper that it is possible to drop the coefficients on the pre-treatment years (hence the ‘pooling’ in his use of the pooled OLS or POLS term), and this is what, in fact the package <code>fixest</code> does as well, so it does not, by default, provide any test of pre-trends like the CS method does above. You may notice that there is no time-varying treatment in the equation above, but <span class="citation" data-cites="Wooldridge:2021aa">Wooldridge (<a href="#ref-Wooldridge:2021aa" role="doc-biblioref">2021</a>)</span> notes in his paper that it is sufficient to use the interactions <span class="math inline">\(d_{ir} \times fs_{t}\)</span> because <span class="math inline">\(w_{it} \times d_{ir} \times fs_{t} = d_{ir} \times fs_{t}\)</span>. However, as we will see later the latter form is helpful for estimating marginal effects, which is likely to be helpful in the context of non-linear models.</p>
<p>Interestingly, Wooldridge also notes that when multiple clusters are treated at the same time (e.g, we have 10 states treated in 2014), one can include fixed effects for the treatment cohorts rather than each individual cluster (though the SEs should still be clustered at the state level).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(etwfe)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>etwfe <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat<span class="sc">:</span><span class="fu">i</span>(cohort_year, i.year, <span class="at">ref=</span><span class="cn">Inf</span>, <span class="at">ref2 =</span> <span class="dv">2011</span>) <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>etwfe_c <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat<span class="sc">:</span><span class="fu">i</span>(cohort_year, i.year, <span class="at">ref=</span><span class="cn">Inf</span>, <span class="at">ref2 =</span> <span class="dv">2011</span>) <span class="sc">|</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    cohort_year <span class="sc">+</span> year,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>ti2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, cs<span class="sc">$</span>group, <span class="st">","</span>, cs<span class="sc">$</span>t, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> cs<span class="sc">$</span>att,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> cs<span class="sc">$</span>se)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>gl2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>cs_atts <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti2, <span class="at">glance =</span> gl2)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(cs_atts) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with CS method</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"Wooldridge: cluster FEs"</span> <span class="ot">=</span> etwfe, </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Wooldridge: cohort FEs"</span> <span class="ot">=</span> etwfe_c,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Callaway Sant'Anna"</span> <span class="ot">=</span> cs_atts),</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_rename =</span> </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"treat:cohort_year::2014:year::2014"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2014)"</span>,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2015"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2015)"</span>,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2016"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2016)"</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2017"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2017)"</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2018"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2018)"</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2019"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2019)"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2020"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2020)"</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2016"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2016)"</span>,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2017"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2017)"</span>,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2018"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2018)"</span>,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2019"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2019)"</span>,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2020"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2020)"</span>),</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">shape =</span> term <span class="sc">~</span> model,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'DF|Deviance|R2|AIC|BIC|Log.Lik|ICC|RMSE'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> Wooldridge: cluster FEs </th>
   <th style="text-align:center;"> Wooldridge: cohort FEs </th>
   <th style="text-align:center;"> Callaway Sant'Anna </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(2014,2014) </td>
   <td style="text-align:center;"> 1.813 </td>
   <td style="text-align:center;"> 1.813 </td>
   <td style="text-align:center;"> 1.747 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.155) </td>
   <td style="text-align:center;"> (0.155) </td>
   <td style="text-align:center;"> (0.227) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2015) </td>
   <td style="text-align:center;"> 4.260 </td>
   <td style="text-align:center;"> 4.260 </td>
   <td style="text-align:center;"> 4.195 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.183) </td>
   <td style="text-align:center;"> (0.183) </td>
   <td style="text-align:center;"> (0.233) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2016) </td>
   <td style="text-align:center;"> 6.078 </td>
   <td style="text-align:center;"> 6.078 </td>
   <td style="text-align:center;"> 5.968 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.173) </td>
   <td style="text-align:center;"> (0.173) </td>
   <td style="text-align:center;"> (0.238) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2017) </td>
   <td style="text-align:center;"> 8.021 </td>
   <td style="text-align:center;"> 8.021 </td>
   <td style="text-align:center;"> 7.911 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.185) </td>
   <td style="text-align:center;"> (0.185) </td>
   <td style="text-align:center;"> (0.275) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2018) </td>
   <td style="text-align:center;"> 9.889 </td>
   <td style="text-align:center;"> 9.889 </td>
   <td style="text-align:center;"> 9.779 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.247) </td>
   <td style="text-align:center;"> (0.247) </td>
   <td style="text-align:center;"> (0.261) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2019) </td>
   <td style="text-align:center;"> 11.907 </td>
   <td style="text-align:center;"> 11.907 </td>
   <td style="text-align:center;"> 11.796 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.133) </td>
   <td style="text-align:center;"> (0.133) </td>
   <td style="text-align:center;"> (0.180) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2020) </td>
   <td style="text-align:center;"> 13.919 </td>
   <td style="text-align:center;"> 13.919 </td>
   <td style="text-align:center;"> 13.809 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.183) </td>
   <td style="text-align:center;"> (0.183) </td>
   <td style="text-align:center;"> (0.216) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2016) </td>
   <td style="text-align:center;"> 1.173 </td>
   <td style="text-align:center;"> 1.173 </td>
   <td style="text-align:center;"> 1.313 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.121) </td>
   <td style="text-align:center;"> (0.121) </td>
   <td style="text-align:center;"> (0.176) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2017) </td>
   <td style="text-align:center;"> 2.141 </td>
   <td style="text-align:center;"> 2.141 </td>
   <td style="text-align:center;"> 2.281 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.189) </td>
   <td style="text-align:center;"> (0.189) </td>
   <td style="text-align:center;"> (0.263) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2018) </td>
   <td style="text-align:center;"> 3.015 </td>
   <td style="text-align:center;"> 3.015 </td>
   <td style="text-align:center;"> 3.155 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.204) </td>
   <td style="text-align:center;"> (0.204) </td>
   <td style="text-align:center;"> (0.252) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2019) </td>
   <td style="text-align:center;"> 4.161 </td>
   <td style="text-align:center;"> 4.161 </td>
   <td style="text-align:center;"> 4.301 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.137) </td>
   <td style="text-align:center;"> (0.137) </td>
   <td style="text-align:center;"> (0.217) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2020) </td>
   <td style="text-align:center;"> 5.083 </td>
   <td style="text-align:center;"> 5.083 </td>
   <td style="text-align:center;"> 5.222 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.147) </td>
   <td style="text-align:center;"> (0.147) </td>
   <td style="text-align:center;"> (0.178) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2012) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.039 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.187) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2014,2013) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.118 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.199) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2012) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.082 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.221) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2013) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.084 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.213) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2014) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.033 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.291) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016,2015) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.262 </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.168) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Std.Errors </td>
   <td style="text-align:center;"> by: state </td>
   <td style="text-align:center;"> by: state </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: year </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: state </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: cohort_year </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> X </td>
   <td style="text-align:center;">  </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The estimates are similar, though not identical, to those from the CS approach. Note also that the SEs are generally smaller in the ETWFE models, since ETWFE pools across never-treated and not-yet treated cohorts in the pre-period, whereas CS only uses the period just before treatment. Wooldridge makes a case for this as a reason to prefer ETWFE over CS, since it uses more of the available information based on the identifying assumptions (section 6.8). Note also that the ETWFE implementation does not provide ATTs for the pre-intervention periods. Wooldridge talks more about this issue in the paper, but does provide some rationale and methods for testing pre-trends.</p>
</section>
<section id="marginal-effects-from-etwfe" class="level2">
<h2 class="anchored" data-anchor-id="marginal-effects-from-etwfe">Marginal effects from ETWFE</h2>
<p>In contrast to the <code>did</code> package (or <code>csdid</code> in Stata) from CS that automatically provides different aggregated ATTs, with ETWFE we need to do this by hand. The <code>marginaleffects</code> package makes this pretty straightforward. The basic idea here is to use the extended TWFE model to generate marginal predictions (and contrasts of marginal predictions) over different combinations of covariates (e.g., simple averaging, groups, time-since-treatment).</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">Simple</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Cohort</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Calendar Time</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false" href="">Dynamic</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect for ETWFE (simple)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>me_avg <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"treat"</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>ti <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_avg<span class="sc">$</span>term[<span class="dv">2</span>], <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_avg<span class="sc">$</span>estimate[<span class="dv">2</span>],</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_avg<span class="sc">$</span>std.error[<span class="dv">2</span>])</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>gl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>etwfe_me_avg <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti, <span class="at">glance =</span> gl)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_avg) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"Simple Average"</span> <span class="ot">=</span> etwfe_me_avg),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> Simple Average </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(treat) </td>
   <td style="text-align:center;"> 6.074 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.083) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by cohort)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>me_c <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> cohort_year),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"cohort_year"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>ti_c <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT(g"</span>, me_c<span class="sc">$</span>cohort_year, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_c<span class="sc">$</span>estimate, </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_c<span class="sc">$</span>std.error)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>etwfe_me_c <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_c, <span class="at">glance =</span> gl)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_c) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"By cohort"</span> <span class="ot">=</span> etwfe_me_c),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> By cohort </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(g2014) </td>
   <td style="text-align:center;"> 7.984 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.115) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(g2016) </td>
   <td style="text-align:center;"> 3.115 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.088) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by cohort)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>me_t <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> year<span class="sc">&gt;=</span><span class="dv">2014</span>),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"year"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>ti_t <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_t<span class="sc">$</span>year, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_t<span class="sc">$</span>estimate, </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_t<span class="sc">$</span>std.error)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>etwfe_me_t <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_t, <span class="at">glance =</span> gl)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_t) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"By year"</span> <span class="ot">=</span> etwfe_me_t),</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> By year </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(2014) </td>
   <td style="text-align:center;"> 1.813 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.155) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2015) </td>
   <td style="text-align:center;"> 4.260 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.183) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2016) </td>
   <td style="text-align:center;"> 3.750 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.128) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2017) </td>
   <td style="text-align:center;"> 5.230 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.149) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2018) </td>
   <td style="text-align:center;"> 6.626 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.203) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2019) </td>
   <td style="text-align:center;"> 8.230 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.108) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2020) </td>
   <td style="text-align:center;"> 9.724 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.141) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to add event indicators to the dataset </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> year <span class="sc">-</span> cohort_year)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by time since treatment)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>me_e <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> event<span class="sc">&gt;=</span><span class="dv">0</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"event"</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>ti_e <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_e<span class="sc">$</span>event, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_e<span class="sc">$</span>estimate, </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_e<span class="sc">$</span>std.error)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>etwfe_me_e <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_e, <span class="at">glance =</span> gl)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_e) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"Event study"</span> <span class="ot">=</span> etwfe_me_e),</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> Event study </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> ATT(0) </td>
   <td style="text-align:center;"> 1.509 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.098) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(1) </td>
   <td style="text-align:center;"> 3.255 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.131) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(2) </td>
   <td style="text-align:center;"> 4.624 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.120) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(3) </td>
   <td style="text-align:center;"> 6.189 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.121) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(4) </td>
   <td style="text-align:center;"> 7.608 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.167) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(5) </td>
   <td style="text-align:center;"> 11.907 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.133) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> ATT(6) </td>
   <td style="text-align:center;"> 13.919 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.183) </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
<p>In general, it’s good to see that these different estimates of various aggregate ATTs are similar to what one gets from the CS model.</p>
</section>
<section id="estimation-in-stata" class="level2">
<h2 class="anchored" data-anchor-id="estimation-in-stata">Estimation in Stata</h2>
<p>It is mostly straightforward to also code this up in a similar way using Stata, but generally it seems easiest to create many of the indicators and product terms by hand rather than using Stata’s interaction operators.</p>
<p>Let’s start with the basic TWFE model, just to verify that it is wrong in the same way as our TWFE estimate was at the beginning, which was 3.5 with an SE of 0.67:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Similar setup for Stata</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RStata)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataVersion"</span> <span class="ot">=</span> <span class="dv">16</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataPath"</span><span class="ot">=</span> <span class="st">'/Applications/Stata/StataMP.app/Contents/MacOS/stata-mp'</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>s_twfe <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="st">qui xtreg y i.treat i.year, i(state) fe vce(cluster state) cformat(%4.3f)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="st">estimates store xttwfe</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="st">estimates table xttwfe, b se keep(1.treat)</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="fu">stata</span>(s_twfe, <span class="at">data.in=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>. 
. qui xtreg y i.treat i.year, i(state) fe vce(cluster state) cformat(%4.3f)
. estimates store xttwfe
. estimates table xttwfe, b se keep(1.treat)

---------------------------
    Variable |   xttwfe    
-------------+-------------
     1.treat |  3.6968941  
             |  .66533664  
---------------------------
               legend: b/se</code></pre>
</div>
</div>
<p>Okay so, basically the same. Now let’s run the extended TWFE model. In order to make estimating the marginal effects for aggregate ATTs a bit easier, we use the Wooldridge specification that interacts the time-varying treatment indicator with both the cohort and time dummies. This is done ‘by hand’ using product terms between the treatment indicator (<code>treat</code>), cohort indicators (<code>gXXXX</code>) and year indicators (<code>yXXXX</code>), for example <code>c.treat#c.g2014#c.y2014</code> and so on for each of the required product terms.</p>
<p>To estimate the marginal effects is pretty straightforward, largely accomplished by using the <code>dydx(treat)</code> on the treated subpopulation (i.e, <code>subpop(treat=1)</code>) and then aggregating over various dimensions (event, cohorts, years, etc.)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new dataset for Stata analysis</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>dstata <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y2014 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2014</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2015 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2015</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2016 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2017 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2017</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2018 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2018</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2019 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2019</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2020 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2020</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">g2014 =</span> <span class="fu">if_else</span>(cohort_year <span class="sc">==</span> <span class="dv">2014</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">g2016 =</span> <span class="fu">if_else</span>(cohort_year <span class="sc">==</span> <span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">event =</span> year <span class="sc">-</span> cohort_year)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>s_etwfe <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="st">qui xtreg y c.treat#c.g2014#c.y2014 c.treat#c.g2014#c.y2015 ///</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2016 c.treat#c.g2014#c.y2017 ///</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2018 c.treat#c.g2014#c.y2019 ///</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2020 c.treat#c.g2016#c.y2016 ///</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2016#c.y2017 c.treat#c.g2016#c.y2018 ///</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2016#c.y2019 c.treat#c.g2016#c.y2020 ///</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="st">        y2014 y2015 y2016 y2017 y2018 y2019 y2020, ///</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="st">        i(state) fe vce(cluster state) cformat(%4.3f)</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="st">estimates store etwfe</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="st">esttab etwfe, b se keep(c.treat#*) nostar nonotes varwidth(25)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="st">* aggregate ATTs</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="st">* simple</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="st">margins, dydx(treat) subpop(if treat==1)</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="st">* group effects</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="st">margins, subpop(if treat==1) dydx(treat) over(cohort_year)</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="st">* calendar effects</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="st">margins, subpop(if treat==1) dydx(treat) over(year)</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="st">* dynamic effects</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="st">margins, dydx(treat) subpop(if treat==1)  over(event)</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="fu">stata</span>(s_etwfe, <span class="at">data.in=</span>dstata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>. 
. qui xtreg y c.treat#c.g2014#c.y2014 c.treat#c.g2014#c.y2015 ///
&gt;         c.treat#c.g2014#c.y2016 c.treat#c.g2014#c.y2017 ///
&gt;         c.treat#c.g2014#c.y2018 c.treat#c.g2014#c.y2019 ///
&gt;         c.treat#c.g2014#c.y2020 c.treat#c.g2016#c.y2016 ///
&gt;         c.treat#c.g2016#c.y2017 c.treat#c.g2016#c.y2018 ///
&gt;         c.treat#c.g2016#c.y2019 c.treat#c.g2016#c.y2020 ///
&gt;         y2014 y2015 y2016 y2017 y2018 y2019 y2020, ///
&gt;         i(state) fe vce(cluster state) cformat(%4.3f)
. estimates store etwfe
. esttab etwfe, b se keep(c.treat#*) nostar nonotes varwidth(25)

--------------------------------------
                                   (1)
                                     y
--------------------------------------
c.treat#c.g2014#c.y2014          1.813
                               (0.155)

c.treat#c.g2014#c.y2015          4.260
                               (0.183)

c.treat#c.g2014#c.y2016          6.078
                               (0.173)

c.treat#c.g2014#c.y2017          8.021
                               (0.185)

c.treat#c.g2014#c.y2018          9.889
                               (0.247)

c.treat#c.g2014#c.y2019          11.91
                               (0.133)

c.treat#c.g2014#c.y2020          13.92
                               (0.183)

c.treat#c.g2016#c.y2016          1.173
                               (0.121)

c.treat#c.g2016#c.y2017          2.141
                               (0.189)

c.treat#c.g2016#c.y2018          3.015
                               (0.204)

c.treat#c.g2016#c.y2019          4.161
                               (0.137)

c.treat#c.g2016#c.y2020          5.083
                               (0.147)
--------------------------------------
N                                10000
--------------------------------------
. 
. * aggregate ATTs
. * simple
. margins, dydx(treat) subpop(if treat==1)

Average marginal effects                        Number of obs     =     10,000
Model VCE    : Robust                           Subpop. no. obs   =      4,066

Expression   : Linear prediction, predict()
dy/dx w.r.t. : treat

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       treat |   6.073905   .0828727    73.29   0.000     5.911478    6.236333
------------------------------------------------------------------------------
. 
. * group effects
. margins, subpop(if treat==1) dydx(treat) over(cohort_year)

Average marginal effects                        Number of obs     =     10,000
Model VCE    : Robust                           Subpop. no. obs   =      4,066

Expression   : Linear prediction, predict()
dy/dx w.r.t. : treat
over         : cohort_year

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
treat        |
 cohort_year |
       2014  |   7.984031   .1153571    69.21   0.000     7.757936    8.210127
       2016  |   3.114706   .0875994    35.56   0.000     2.943015    3.286398
------------------------------------------------------------------------------
. 
. * calendar effects
. margins, subpop(if treat==1) dydx(treat) over(year)

Average marginal effects                        Number of obs     =     10,000
Model VCE    : Robust                           Subpop. no. obs   =      4,066

Expression   : Linear prediction, predict()
dy/dx w.r.t. : treat
over         : year

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
treat        |
        year |
       2014  |   1.812944   .1550938    11.69   0.000     1.508965    2.116922
       2015  |   4.260425   .1834583    23.22   0.000     3.900853    4.619996
       2016  |   3.749868   .1284167    29.20   0.000     3.498175     4.00156
       2017  |   5.230177   .1490019    35.10   0.000     4.938138    5.522215
       2018  |    6.62622   .2032745    32.60   0.000     6.227809    7.024631
       2019  |   8.229655   .1080994    76.13   0.000     8.017784    8.441526
       2020  |   9.724495   .1410924    68.92   0.000     9.447959    10.00103
------------------------------------------------------------------------------
. 
. * dynamic effects
. margins, dydx(treat) subpop(if treat==1)  over(event)

Average marginal effects                        Number of obs     =     10,000
Model VCE    : Robust                           Subpop. no. obs   =      4,066

Expression   : Linear prediction, predict()
dy/dx w.r.t. : treat
over         : event

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
treat        |
       event |
          0  |   1.509237    .097564    15.47   0.000     1.318015    1.700458
          1  |    3.25455   .1313684    24.77   0.000     2.997073    3.512027
          2  |    4.62439   .1203647    38.42   0.000      4.38848    4.860301
          3  |   6.188779   .1205432    51.34   0.000     5.952519    6.425039
          4  |   7.607541   .1668296    45.60   0.000     7.280561    7.934521
          5  |   11.90657   .1325372    89.84   0.000      11.6468    12.16634
          6  |   13.91925   .1828063    76.14   0.000     13.56096    14.27755
------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>From these models it seems like the basic estimates for the aggregate ATTs are pretty similar for ETWFE and CS implementations.</p>
<p>Need to add: covariates.</p>
<!-- -->


</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Callaway:2021aa" class="csl-entry" role="doc-biblioentry">
Callaway, Brantly, and Pedro HC Sant’Anna. 2021. <span>“Difference-in-Differences with Multiple Time Periods.”</span> <em>Journal of Econometrics</em> 225 (2): 200–230.
</div>
<div id="ref-Wooldridge:2021aa" class="csl-entry" role="doc-biblioentry">
Wooldridge, Jeffrey M. 2021. <span>“Two-Way Fixed Effects, the Two-Way Mundlak Regression, and Difference-in-Differences Estimators.”</span> <em>Available at SSRN 3906345</em>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This section borrows heavily from Brantly Callaway’s excellent <a href="https://bcallaway11.github.io/did/articles/TWFE.html">vignette</a> on the dangers of using Two-Way Fixed Effects (TWFE) in the context of staggered treatments.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This <a href="https://andrewcbaker.netlify.app/2020/06/27/how-to-create-relative-time-indicators/#">post</a> by Andrew Baker suggests to me that fully saturating this model with all of the relative time indicators may work, but binning the ends if you have a longer series creates problems.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb21" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Difference-in-Differences with Heterogenous Treatment Effects"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Sam Harper</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-05-24</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> did-exp.bib</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="fu"># Setup </span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>In this document we aim to provide an overview of the issues and methods for evaluating policy impacts in the context of heterogeneous treatments and staggered treatments.</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simulated data</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sim, message=FALSE}</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">394</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="co"># unit fixed effects (unobserved heterogeneity)</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>unit <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate clusters</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">unit_fe =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, state<span class="sc">/</span><span class="dv">10</span>, <span class="dv">1</span>),</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate instantaneous treatment effect</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mu = rnorm(nobs, true_mu, 0.2)</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> <span class="dv">2</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co"># year fixed effects (first part)</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2020</span>,</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_fe =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(year), <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Put the clusters into treatment groups</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>treat_taus <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sample the clusters randomly</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="dv">30</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>),</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># place the randomly sampled states into 1\{t \ge g \}G_g</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">cohort_year =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">2014</span>, <span class="dv">2016</span>, <span class="dv">2018</span>), <span class="dv">10</span>))</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="co"># make main dataset</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co"># full interaction of unit X year </span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="at">year =</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2020</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., unit) <span class="sc">%&gt;%</span> </span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., year) <span class="sc">%&gt;%</span> </span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(., treat_taus) <span class="sc">%&gt;%</span> </span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make error term and get treatment indicators and treatment effects</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also get cohort specific trends (modify time FE)</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span><span class="sc">*</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">treat =</span> <span class="fu">ifelse</span>((year <span class="sc">&gt;=</span> </span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>           cohort_year)<span class="sc">*</span>(cohort_year <span class="sc">!=</span> <span class="dv">2018</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>         <span class="co"># treatment effect = 1 if 2016, 2 if 2014, annually</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>         <span class="at">mu =</span> <span class="fu">ifelse</span>(cohort_year<span class="sc">==</span><span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>         <span class="at">tau =</span> <span class="fu">ifelse</span>(treat <span class="sc">==</span> <span class="dv">1</span>, mu, <span class="dv">0</span>),</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">year_fe =</span> year_fe <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>(year <span class="sc">-</span> cohort_year)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate cumulative treatment effects</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span> </span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tau_cum =</span> <span class="fu">cumsum</span>(tau)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the dependent variable</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> (<span class="dv">2020</span> <span class="sc">-</span> cohort_year) <span class="sc">+</span> </span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>           unit_fe <span class="sc">+</span> year_fe <span class="sc">+</span> tau_cum <span class="sc">+</span> error) <span class="sc">%&gt;%</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relabel 2018 cohort as never-treated</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_year =</span> <span class="fu">ifelse</span>(cohort_year <span class="sc">==</span> <span class="dv">2018</span>, <span class="cn">Inf</span>, cohort_year))</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>For this example we will use a simulated example.^<span class="co">[</span><span class="ot">This section borrows heavily from Brantly Callaway's excellent [vignette](https://bcallaway11.github.io/did/articles/TWFE.html) on the dangers of using Two-Way Fixed Effects (TWFE) in the context of staggered treatments.</span><span class="co">]</span> For the time being, we are ignoring covariates. </span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>We are simulating a staggered treatment setup where 30 'clusters', which could be countries, villages, states, etc., but in this case we will use states ($state = <span class="sc">\{</span>1,2,\dots,30<span class="sc">\}</span>$), which are randomly assigned into 3 treatment groups depending on the treatment starting year (2014, 2016, never treated). We denote the treatment starting period as $g$ that encompasses the 3 groups (i.e., $g \in <span class="sc">\{</span> 2014, 2016, \text{-Inf}<span class="sc">\}</span>$), where $\text{-Inf}$ indicates the never treated group (following @{Callaway:2021aa} here such that $g = \infty$ for a never-treated group). We have 1000 units spread out over the 30 clusters, which could be individuals, schools, hospitals, or some other smaller units $i$, which are randomly assigned to one of the 30 states. Let $G_i$ indicates the group/cohort unit $i$ belongs to, i.e., $G \subseteq <span class="sc">\{</span> 2014, 2016, \infty<span class="sc">\}</span>$.</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>The data generating process (DGP) for the outcome $Y$ is: </span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>$$Y_{it} = (2020-g) + \alpha_i + \beta_t + \tau_{it} + \epsilon_{it}$$</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>where $\alpha_i$ are unit (i.e., cluster) fixed effects drawn from $\sim N(\mu_{state}, 1)$ with state-specific mean $\mu_{state} = state/10$, $\beta_t$ are time fixed effects (cohort-specific parallel time-trends) generated as $$\beta_t = 0.5 * (t - g) + \epsilon^{time FE}_t, $$ with $\epsilon^{time FE}_t \sim N(0, 1)$, $\epsilon_{i,t} \sim N(0,2)$ is an idiosyncratic error term. The $\tau_{i,t}$ are the (instantaneous) unit-specific treatment effects at time $t$ generated as </span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>$$ \tau_{it} = \mu_g \times (t - g + 1)\times 1<span class="sc">\{</span>t \ge g <span class="sc">\}</span>1<span class="sc">\{</span>g\not=\infty <span class="sc">\}</span>,$$</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>where $t$ and $g$ are defined as above and $1<span class="sc">\{\}</span>$ is a logical operator. We set $\mu_{2014} = 2$, and $\mu_{2016} = 1$. </span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>So, for example, in 2014 when $G_{2014}$ is first treated, $(t - g + 1)=1$ and the treatment effect is 2. This setup implies heterogeneity: for the group that started treatment in 2014, its average treatment effects evolves with time since first treatment as $2,4,6,\dots$. For the group that started treatment in 2016 the average treatment effect evolves with elapsed time as $1,2,3,\dots$. The treatment effect is zero for the "never-treated" cohort ($g=\infty$). In this case the early-treated group ($g=2014$) benefits more than the later treated group.</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>Given that each group has same size (on average), the true average treatment effect dynamic across treated groups is $(2+1)/2 = 1.5$ at the time a unit is treated, $2 \times (2+1)/2 = 3$ in the first period after treatment started, etc.</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>A random sample of 10 rows of the data are shown below:</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simtab, results = 'asis', cache=TRUE, message=FALSE}</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="fu">sample_n</span>(d,<span class="dv">10</span>)</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(ds, <span class="at">caption =</span> <span class="st">"10 rows of simulated data"</span>, <span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plot of simulated data</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>Below we show the evolution of $y$ over time for the 3 treatment groups (2014, 2016, untreated). The vertical lines indicate the time of treatment, i.e. $g=t$ for each treated group, and the bold lines show the average evolution of the outcome for each treatment group.</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plotsim, cache=TRUE, message=FALSE}</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_blank</span>()))</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y, <span class="at">group =</span> unit)) <span class="sc">+</span> </span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span> </span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cohort_year, year) <span class="sc">%&gt;%</span> </span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">mean</span>(y)),</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>   <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> y, <span class="at">group =</span> <span class="fu">factor</span>(cohort_year),</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(cohort_year)), <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Y"</span>,  <span class="at">color =</span> <span class="st">"Treatment group   "</span>) <span class="sc">+</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2012</span>, <span class="dv">2014</span>, <span class="dv">2016</span>, <span class="dv">2018</span>, <span class="dv">2020</span>)) <span class="sc">+</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2014</span>, <span class="at">color =</span> <span class="st">'#E41A1C'</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2016</span>, <span class="at">color =</span> <span class="st">'#377EB8'</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">'Set1'</span>) <span class="sc">+</span> </span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">#legend.title = element_blank(), </span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"2014"</span>, <span class="st">"2016"</span>, <span class="st">"Never-treated"</span>),</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>                     <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#E41A1C"</span>, <span class="st">"#377EB8"</span>, <span class="st">"#4DAF4A"</span>)) <span class="sc">+</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Simulated data with heterogeneous treatment effect dynamics across cohorts </span><span class="sc">\n</span><span class="st"> and with a never-treated group"</span>)<span class="sc">+</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>))</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>plot </span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a><span class="fu"># Estimating treatment effects</span></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>Next we show various ways of estimating the treatment effects, starting with the standard two-way fixed effects (TWFE) that has been standard in many diff-in-diffs analyses. </span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a><span class="fu">## TWFE (average)</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>The basic model is estimated as:</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>$$Y_{it} = \alpha_i + \beta_t + \gamma D_{it} + \varepsilon_{it}$$ </span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>where $D_{i,t}$ is a time-varying treatment dummy variable that takes value one if a unit $i$ is treated at time $t$, and $\alpha_{i}$ and $\beta_{t}$ are fixed effects for unit and time, respectively. We implement this below using the <span class="in">`fixest`</span> package and cluster the standard errors at the state level. </span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r est, message=FALSE}</span></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDummies)</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a><span class="fu">## TWFE (dynamic)</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>Many analyses using TWFE also typically implement an 'event study' type analysis as a robustness check, both to see how the treatment effect may evolve over time in the post period and to see whether there may be some evidence of non-parallel trends in the pre-treatment period. We can implement the event-study type model as:</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>$$Y_{it} = \alpha_i + \beta_t + \sum_{k\neq-1} \gamma_{k} D_{it} + \varepsilon_{it}$$ </span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>where $k$ indicates time indicators relative to first treatment (i.e., $k=-2$ means 2 periods prior to treatment) and $\gamma_{k}$ are the coefficients on the relative time indicators. To avoid collinearity we exclude one period, which is typically the period just before first treatment ($k=-1$). </span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>Below is a table showing the estimated effects from the TWFE and event-study models. The overall average estimate from the traditional TWFE model is 3.5, which we know isn't correct, since the average effect should be something closer to $\frac{1}{7}\sum_{t=1}^{7} t*(2+1)/2 = 6$ </span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r es, cache=TRUE}</span></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate TWFE</span></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>twfe <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a><span class="co"># first make dummy columns for relative time</span></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make dummies</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rel_year =</span> year <span class="sc">-</span> cohort_year) <span class="sc">%&gt;%</span> </span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dummy_cols</span>(<span class="at">select_columns =</span> <span class="st">"rel_year"</span>) </span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the model</span></span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>twfe_event <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="st">`</span><span class="at">rel_year_-5</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-4</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-3</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">rel_year_-2</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_0</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_1</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rel_year_2</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_3</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_4</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">rel_year_5</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_6</span><span class="st">`</span> <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>rename_rt <span class="ot">&lt;-</span> <span class="cf">function</span>(old_names) {</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>  new_names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"rel_year_"</span>, <span class="st">"Relative time: "</span>, old_names)</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(new_names, old_names)</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"TWFE"</span> <span class="ot">=</span> twfe, </span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>  <span class="st">"TWFE:Event study"</span> <span class="ot">=</span> twfe_event),</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_rename =</span> rename_rt,</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'DF|Deviance|R2|AIC|BIC|Log.Lik|ICC|RMSE'</span>)</span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>How well do the event study coefficients map on to our true estimates from the DGP? Below we show a plot of the true effects based on the simulated data, as well as the estimates from the event study. The answer is: okay? The TWFE estimates are sensible in the post period, but they also suggest some evidence for non-parallel trends in the pre-period, which, in the before times, might lead one to think the parallel trends assumption is violated, which we know is not the case here since we forced the model to be parallel in the pre period <span class="co">[</span><span class="ot">some text on intuition for this would be helpful here</span><span class="co">]</span>.^<span class="co">[</span><span class="ot">This [post](https://andrewcbaker.netlify.app/2020/06/27/how-to-create-relative-time-indicators/#) by Andrew Baker suggests to me that fully saturating this model with all of the relative time indicators may work, but binning the ends if you have a longer series creates problems.</span><span class="co">]</span></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r esp, cache=TRUE, message = FALSE, warning=FALSE}</span></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of estimates</span></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>pt <span class="ot">&lt;-</span> <span class="fu">get_estimates</span>(twfe_event) <span class="sc">%&gt;%</span></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">t =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">0</span>, </span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.low =</span> <span class="dv">0</span>, <span class="at">conf.high =</span> <span class="dv">0</span>, <span class="at">term =</span> <span class="st">"rel_year_-1"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">true_tau =</span> </span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> t <span class="sc">&lt;</span> <span class="dv">5</span>, ((t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.5</span>), </span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(t <span class="sc">&gt;</span> <span class="dv">4</span>, (t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">0</span>)))</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True Effect"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Estimated Effect"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>plot_es <span class="ot">&lt;-</span> pt <span class="sc">%&gt;%</span></span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate)) <span class="sc">+</span> </span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">'Estimated Effect'</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high), </span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau, <span class="at">color =</span> <span class="st">'True Effect'</span>), </span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Relative Time"</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"TWFE event-study regression estimates"</span>) <span class="sc">+</span></span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_blank</span>())</span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a>plot_es</span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a><span class="fu">## Callaway-Sant'Anna</span></span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a>To avoid the problems with the TWFE specification above, we can instead use the approach recently developed by @{Callaway:2021aa} that estimates the average treatment effect on the treated ($ATT$) for each treated group $g$ at each time $t$, i.e., $ATT(g,t)$, where groups are defined according to when they were first treated. The group-time specific estimates of each $ATT(g,t)$ are estimated via regression on *subsets* of the data for each group and time periods covering pre- and post-intervention, using the following specification:</span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a>$$Y_{it} = \beta_{0}^{gt} + \beta_{1}^{gt}G + \beta_{2}^{gt}T + \beta_{3}^{gt}(G\times T) + \varepsilon^{gt} $$</span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a>where $G$ and $T$ refer to indicators for group and time period and $\beta_{3}^{gt}$ is the $ATT(g,t)$ for each group at a given time. Treated groups are compared to not yet treated groups to estimate group-time specific $ATTs$ , which can be combined to estimate the overall effect of the intervention, as well as dynamic treatment effects. </span>
<span id="cb21-242"><a href="#cb21-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-243"><a href="#cb21-243" aria-hidden="true" tabindex="-1"></a>The table below compares the estimates from the TWFE model to 'simple' aggregate estimate from the CS model. As before, we know that the 'truth' here should be something like an average $ATT$ of 6. The TWFE estimate is wrong and biased downwards to around 3.5, where as the CS estimate is 5.9, about what it should be.</span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cs, message=FALSE, warning=FALSE}</span></span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Callaway-Sant'Anna</span></span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a>cs <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">"y"</span>, </span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a>                  <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a>                  <span class="at">idname =</span> <span class="st">"unit"</span>,</span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gname =</span> <span class="st">"cohort_year"</span>,</span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control_group=</span> <span class="st">"notyettreated"</span>,</span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a>                  <span class="at">bstrap =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a>                  <span class="at">clustervars =</span> <span class="st">"state"</span>,</span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d,</span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a>                  <span class="at">print_details =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a>cs_simple <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"simple"</span>)</span>
<span id="cb21-258"><a href="#cb21-258" aria-hidden="true" tabindex="-1"></a>cs_event <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb21-259"><a href="#cb21-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a>ti <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">"treat"</span>,</span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> cs_simple<span class="sc">$</span>overall.att,</span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> cs_simple<span class="sc">$</span>overall.se)</span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a>gl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a>cs_avg <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti, <span class="at">glance =</span> gl)</span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(cs_avg) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"TWFE"</span> <span class="ot">=</span> twfe, <span class="st">"Callway-Sant'Anna"</span> <span class="ot">=</span> cs_avg),</span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a>Estimating each group-time ATT in the CS way also allows several different ways of aggregating ATTs, depending on the question at hand. Above we showed the 'simple' average ATT, but it is also possible to look at dynamic trends or estimates for each separate treated cohort:</span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-279"><a href="#cb21-279" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dynamic</span></span>
<span id="cb21-280"><a href="#cb21-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r csd, message=FALSE, warning = FALSE}</span></span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a>cs_event <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"dynamic"</span>)</span>
<span id="cb21-283"><a href="#cb21-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-284"><a href="#cb21-284" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Dynamic"</span> <span class="ot">=</span> cs_event),</span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a><span class="fu">### Group</span></span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r csg, message=FALSE, warning = FALSE}</span></span>
<span id="cb21-290"><a href="#cb21-290" aria-hidden="true" tabindex="-1"></a>cs_group <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"group"</span>)</span>
<span id="cb21-291"><a href="#cb21-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Group"</span> <span class="ot">=</span> cs_group),</span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calendar</span></span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a><span class="in">```{r csc, message=FALSE, warning = FALSE}</span></span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a>cs_cal <span class="ot">&lt;-</span> did<span class="sc">::</span><span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"calendar"</span>)</span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"CS: Calendar"</span> <span class="ot">=</span> cs_cal),</span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'_*'</span>)</span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>From the "Group" estimates you can see that the average treatment effect for cohort first treated in 2014 is 8, whereas the effect for the cohort first treated in 2016 is around 2.6. The average reported here is different than the simple average above because it is the average effect of the two groups, rather than the simple average. The 'calendar' estimates are average for each time $t$ in the post-treatment period, which is different than the 'dynamic' effects, which are averages by time since first treated. </span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a>Let's also just look and see at how our 'dynamic' estimates using CS compare to the truth:</span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r escs, cache=TRUE, message = FALSE, warning=FALSE}</span></span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of estimates</span></span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a>ptcs <span class="ot">&lt;-</span> <span class="fu">get_estimates</span>(cs_event) <span class="sc">%&gt;%</span></span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, conf.low, conf.high) <span class="sc">%&gt;%</span></span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span><span class="sc">:-</span><span class="dv">1</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">true_tau =</span> </span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> t <span class="sc">&lt;</span> <span class="dv">5</span>, ((t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.5</span>), </span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a>           <span class="fu">ifelse</span>(t <span class="sc">&gt;</span> <span class="dv">4</span>, (t <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">0</span>)))</span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"True Effect"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Estimated Effect"</span> <span class="ot">=</span> <span class="st">"blue"</span>)</span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a>plot_escs <span class="ot">&lt;-</span> ptcs <span class="sc">%&gt;%</span></span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate)) <span class="sc">+</span> </span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="st">'Estimated Effect'</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high), </span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau, <span class="at">color =</span> <span class="st">'True Effect'</span>), </span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Relative Time"</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"CS event-study regression estimates"</span>) <span class="sc">+</span></span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_blank</span>())</span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a>plot_escs</span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a>These estimates look good, with no evidence of non-parallel trends in the pre-intervention period.</span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a><span class="fu">## 'Extended' TWFE</span></span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a>In a recent paper @{Wooldridge:2021aa} demonstrated that the issue we saw with the TWFE model above is not a problem with the TWFE model *per se*, only the way that it is specified. In particular, he notes that one can recover nearly identical $ATT(g,t)$ estimates from the linear TWFE model by including a set of interactive fixed effects between treated cohorts and time since treatment. This idea has been referred to as 'extended' TWFE, and basically amounts to interacting a time-varying treatment indicator with both the cohort-year indicators and each time period. He uses somewhat different terminology that we will try to adopt here, such that the time-varying treatment indicator is $w_{it}$, cohort dummies indicating treatment at specific times $r$ since the time $q$ the first group is treated, i.e., $d_{r}$ and time period dummies $fs_{t}$ for every possible period $s$ after the first cohort is treated. Putting this together the ETWFE model ends up looking something like this:</span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a>$$Y_{it} = \alpha + \sum_{r=q}^{T} \beta_{r} d_{r} + \sum_{s=r}^{T} \gamma_{s} fs_{t}+ \sum_{r=q}^{T} \sum_{s=r}^{T} \tau_{rt} (d_{r} \times fs_{t}) + \varepsilon_{it}$$ </span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a>Effectively, we are saturating the regression with interactions between treated cohorts and time, such that the $\tau_{rt}$ are estimates of each group-time ATT. Absent constraints this leads to obvious issues of collinearity. Wooldridge notes in his paper that it is possible to drop the coefficients on the pre-treatment years (hence the 'pooling' in his use of the pooled OLS or POLS term), and this is what, in fact the package <span class="in">`fixest`</span> does as well, so it does not, by default, provide any test of pre-trends like the CS method does above. You may notice that there is no time-varying treatment in the equation above, but @{Wooldridge:2021aa} notes in his paper that it is sufficient to use the interactions $d_{ir} \times fs_{t}$ because $w_{it} \times d_{ir} \times fs_{t} = d_{ir} \times fs_{t}$. However, as we will see later the latter form is helpful for estimating marginal effects, which is likely to be helpful in the context of non-linear models.</span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a>Interestingly, Wooldridge also notes that when multiple clusters are treated at the same time (e.g, we have 10 states treated in 2014), one can include fixed effects for the treatment cohorts rather than each individual cluster (though the SEs should still be clustered at the state level).</span>
<span id="cb21-354"><a href="#cb21-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-355"><a href="#cb21-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r etwfe, warning = FALSE, message = FALSE}</span></span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(etwfe)</span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>etwfe <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat<span class="sc">:</span><span class="fu">i</span>(cohort_year, i.year, <span class="at">ref=</span><span class="cn">Inf</span>, <span class="at">ref2 =</span> <span class="dv">2011</span>) <span class="sc">|</span> state <span class="sc">+</span> year,</span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-364"><a href="#cb21-364" aria-hidden="true" tabindex="-1"></a>etwfe_c <span class="ot">=</span> fixest<span class="sc">::</span><span class="fu">feols</span>(</span>
<span id="cb21-365"><a href="#cb21-365" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> treat<span class="sc">:</span><span class="fu">i</span>(cohort_year, i.year, <span class="at">ref=</span><span class="cn">Inf</span>, <span class="at">ref2 =</span> <span class="dv">2011</span>) <span class="sc">|</span> </span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a>    cohort_year <span class="sc">+</span> year,</span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> d,</span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span>state</span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a>ti2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, cs<span class="sc">$</span>group, <span class="st">","</span>, cs<span class="sc">$</span>t, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>),</span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> cs<span class="sc">$</span>att,</span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> cs<span class="sc">$</span>se)</span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a>gl2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a>cs_atts <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti2, <span class="at">glance =</span> gl2)</span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(cs_atts) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with CS method</span></span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">"Wooldridge: cluster FEs"</span> <span class="ot">=</span> etwfe, </span>
<span id="cb21-385"><a href="#cb21-385" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Wooldridge: cohort FEs"</span> <span class="ot">=</span> etwfe_c,</span>
<span id="cb21-386"><a href="#cb21-386" aria-hidden="true" tabindex="-1"></a>       <span class="st">"Callaway Sant'Anna"</span> <span class="ot">=</span> cs_atts),</span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_rename =</span> </span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"treat:cohort_year::2014:year::2014"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2014)"</span>,</span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2015"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2015)"</span>,</span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2016"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2016)"</span>,</span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2017"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2017)"</span>,</span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2018"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2018)"</span>,</span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2019"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2019)"</span>,</span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2014:year::2020"</span> <span class="ot">=</span> <span class="st">"ATT(2014,2020)"</span>,</span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2016"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2016)"</span>,</span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2017"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2017)"</span>,</span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2018"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2018)"</span>,</span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2019"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2019)"</span>,</span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a>      <span class="st">"treat:cohort_year::2016:year::2020"</span> <span class="ot">=</span> <span class="st">"ATT(2016,2020)"</span>),</span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">shape =</span> term <span class="sc">~</span> model,</span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'DF|Deviance|R2|AIC|BIC|Log.Lik|ICC|RMSE'</span>)</span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a>The estimates are similar, though not identical, to those from the CS approach. Note also that the SEs are generally smaller in the ETWFE models, since ETWFE pools across never-treated and not-yet treated cohorts in the pre-period, whereas CS only uses the period just before treatment. Wooldridge makes a case for this as a reason to prefer ETWFE over CS, since it uses more of the available information based on the identifying assumptions (section 6.8). Note also that the ETWFE implementation does not provide ATTs for the pre-intervention periods. Wooldridge talks more about this issue in the paper, but does provide some rationale and methods for testing pre-trends. </span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal effects from ETWFE</span></span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a>In contrast to the <span class="in">`did`</span> package (or <span class="in">`csdid`</span> in Stata) from CS that automatically provides different aggregated ATTs, with ETWFE we need to do this by hand. The <span class="in">`marginaleffects`</span> package makes this pretty straightforward. The basic idea here is to use the extended TWFE model to generate marginal predictions (and contrasts of marginal predictions) over different combinations of covariates (e.g., simple averaging, groups, time-since-treatment). </span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple</span></span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r etwfe_me_avg, warning = FALSE, message = FALSE}</span></span>
<span id="cb21-415"><a href="#cb21-415" aria-hidden="true" tabindex="-1"></a><span class="co"># Marginal effect for ETWFE (simple)</span></span>
<span id="cb21-416"><a href="#cb21-416" aria-hidden="true" tabindex="-1"></a>me_avg <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb21-417"><a href="#cb21-417" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb21-418"><a href="#cb21-418" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat),</span>
<span id="cb21-419"><a href="#cb21-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb21-420"><a href="#cb21-420" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"treat"</span></span>
<span id="cb21-421"><a href="#cb21-421" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-422"><a href="#cb21-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-423"><a href="#cb21-423" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-424"><a href="#cb21-424" aria-hidden="true" tabindex="-1"></a>ti <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-425"><a href="#cb21-425" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_avg<span class="sc">$</span>term[<span class="dv">2</span>], <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>),</span>
<span id="cb21-426"><a href="#cb21-426" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_avg<span class="sc">$</span>estimate[<span class="dv">2</span>],</span>
<span id="cb21-427"><a href="#cb21-427" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_avg<span class="sc">$</span>std.error[<span class="dv">2</span>])</span>
<span id="cb21-428"><a href="#cb21-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-429"><a href="#cb21-429" aria-hidden="true" tabindex="-1"></a>gl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-430"><a href="#cb21-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-431"><a href="#cb21-431" aria-hidden="true" tabindex="-1"></a>etwfe_me_avg <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti, <span class="at">glance =</span> gl)</span>
<span id="cb21-432"><a href="#cb21-432" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_avg) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-433"><a href="#cb21-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-434"><a href="#cb21-434" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"Simple Average"</span> <span class="ot">=</span> etwfe_me_avg),</span>
<span id="cb21-435"><a href="#cb21-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span>
<span id="cb21-436"><a href="#cb21-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-437"><a href="#cb21-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-438"><a href="#cb21-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-439"><a href="#cb21-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cohort</span></span>
<span id="cb21-440"><a href="#cb21-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-441"><a href="#cb21-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r etwfe_me_c, warning = FALSE, message = FALSE}</span></span>
<span id="cb21-442"><a href="#cb21-442" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by cohort)</span></span>
<span id="cb21-443"><a href="#cb21-443" aria-hidden="true" tabindex="-1"></a>me_c <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb21-444"><a href="#cb21-444" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb21-445"><a href="#cb21-445" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> cohort_year),</span>
<span id="cb21-446"><a href="#cb21-446" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb21-447"><a href="#cb21-447" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"cohort_year"</span></span>
<span id="cb21-448"><a href="#cb21-448" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-449"><a href="#cb21-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-450"><a href="#cb21-450" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-451"><a href="#cb21-451" aria-hidden="true" tabindex="-1"></a>ti_c <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-452"><a href="#cb21-452" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT(g"</span>, me_c<span class="sc">$</span>cohort_year, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb21-453"><a href="#cb21-453" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_c<span class="sc">$</span>estimate, </span>
<span id="cb21-454"><a href="#cb21-454" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_c<span class="sc">$</span>std.error)</span>
<span id="cb21-455"><a href="#cb21-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-456"><a href="#cb21-456" aria-hidden="true" tabindex="-1"></a>etwfe_me_c <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_c, <span class="at">glance =</span> gl)</span>
<span id="cb21-457"><a href="#cb21-457" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_c) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-458"><a href="#cb21-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-459"><a href="#cb21-459" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"By cohort"</span> <span class="ot">=</span> etwfe_me_c),</span>
<span id="cb21-460"><a href="#cb21-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span>
<span id="cb21-461"><a href="#cb21-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-462"><a href="#cb21-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-463"><a href="#cb21-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-464"><a href="#cb21-464" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calendar Time</span></span>
<span id="cb21-465"><a href="#cb21-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-466"><a href="#cb21-466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r etwfe_me_t, warning = FALSE, message = FALSE}</span></span>
<span id="cb21-467"><a href="#cb21-467" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by cohort)</span></span>
<span id="cb21-468"><a href="#cb21-468" aria-hidden="true" tabindex="-1"></a>me_t <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb21-469"><a href="#cb21-469" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb21-470"><a href="#cb21-470" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> year<span class="sc">&gt;=</span><span class="dv">2014</span>),</span>
<span id="cb21-471"><a href="#cb21-471" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb21-472"><a href="#cb21-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"year"</span></span>
<span id="cb21-473"><a href="#cb21-473" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-474"><a href="#cb21-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-475"><a href="#cb21-475" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-476"><a href="#cb21-476" aria-hidden="true" tabindex="-1"></a>ti_t <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-477"><a href="#cb21-477" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_t<span class="sc">$</span>year, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb21-478"><a href="#cb21-478" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_t<span class="sc">$</span>estimate, </span>
<span id="cb21-479"><a href="#cb21-479" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_t<span class="sc">$</span>std.error)</span>
<span id="cb21-480"><a href="#cb21-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-481"><a href="#cb21-481" aria-hidden="true" tabindex="-1"></a>etwfe_me_t <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_t, <span class="at">glance =</span> gl)</span>
<span id="cb21-482"><a href="#cb21-482" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_t) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"By year"</span> <span class="ot">=</span> etwfe_me_t),</span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dynamic</span></span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-491"><a href="#cb21-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r etwfe_me_e, warning = FALSE, message = FALSE}</span></span>
<span id="cb21-492"><a href="#cb21-492" aria-hidden="true" tabindex="-1"></a><span class="co"># Need to add event indicators to the dataset </span></span>
<span id="cb21-493"><a href="#cb21-493" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb21-494"><a href="#cb21-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> year <span class="sc">-</span> cohort_year)</span>
<span id="cb21-495"><a href="#cb21-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-496"><a href="#cb21-496" aria-hidden="true" tabindex="-1"></a><span class="co"># Group effects for ETWFE (by time since treatment)</span></span>
<span id="cb21-497"><a href="#cb21-497" aria-hidden="true" tabindex="-1"></a>me_e <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb21-498"><a href="#cb21-498" aria-hidden="true" tabindex="-1"></a>  etwfe, </span>
<span id="cb21-499"><a href="#cb21-499" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(d, treat <span class="sc">&amp;</span> event<span class="sc">&gt;=</span><span class="dv">0</span>),</span>
<span id="cb21-500"><a href="#cb21-500" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"treat"</span>, </span>
<span id="cb21-501"><a href="#cb21-501" aria-hidden="true" tabindex="-1"></a>  <span class="at">by        =</span> <span class="st">"event"</span></span>
<span id="cb21-502"><a href="#cb21-502" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-503"><a href="#cb21-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-504"><a href="#cb21-504" aria-hidden="true" tabindex="-1"></a><span class="co"># wrangle aggregate ATTs for model summary table</span></span>
<span id="cb21-505"><a href="#cb21-505" aria-hidden="true" tabindex="-1"></a>ti_e <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-506"><a href="#cb21-506" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="fu">paste</span>(<span class="st">"ATT("</span>, me_e<span class="sc">$</span>event, <span class="st">")"</span>, <span class="at">sep=</span><span class="st">""</span>), </span>
<span id="cb21-507"><a href="#cb21-507" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> me_e<span class="sc">$</span>estimate, </span>
<span id="cb21-508"><a href="#cb21-508" aria-hidden="true" tabindex="-1"></a>  <span class="at">std.error =</span> me_e<span class="sc">$</span>std.error)</span>
<span id="cb21-509"><a href="#cb21-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-510"><a href="#cb21-510" aria-hidden="true" tabindex="-1"></a>etwfe_me_e <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tidy =</span> ti_e, <span class="at">glance =</span> gl)</span>
<span id="cb21-511"><a href="#cb21-511" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(etwfe_me_e) <span class="ot">&lt;-</span> <span class="st">"modelsummary_list"</span></span>
<span id="cb21-512"><a href="#cb21-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-513"><a href="#cb21-513" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"Event study"</span> <span class="ot">=</span> etwfe_me_e),</span>
<span id="cb21-514"><a href="#cb21-514" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_omit =</span><span class="st">'._*'</span>)</span>
<span id="cb21-515"><a href="#cb21-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-516"><a href="#cb21-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-517"><a href="#cb21-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-518"><a href="#cb21-518" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb21-519"><a href="#cb21-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-520"><a href="#cb21-520" aria-hidden="true" tabindex="-1"></a>In general, it's good to see that these different estimates of various aggregate ATTs are similar to what one gets from the CS model.</span>
<span id="cb21-521"><a href="#cb21-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-522"><a href="#cb21-522" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimation in Stata</span></span>
<span id="cb21-523"><a href="#cb21-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-524"><a href="#cb21-524" aria-hidden="true" tabindex="-1"></a>It is mostly straightforward to also code this up in a similar way using Stata, but generally it seems easiest to create many of the indicators and product terms by hand rather than using Stata's interaction operators. </span>
<span id="cb21-525"><a href="#cb21-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-526"><a href="#cb21-526" aria-hidden="true" tabindex="-1"></a>Let's start with the basic TWFE model, just to verify that it is wrong in the same way as our TWFE estimate was at the beginning, which was 3.5 with an SE of 0.67:</span>
<span id="cb21-527"><a href="#cb21-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-528"><a href="#cb21-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st}</span></span>
<span id="cb21-529"><a href="#cb21-529" aria-hidden="true" tabindex="-1"></a><span class="co"># Similar setup for Stata</span></span>
<span id="cb21-530"><a href="#cb21-530" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RStata)</span>
<span id="cb21-531"><a href="#cb21-531" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataVersion"</span> <span class="ot">=</span> <span class="dv">16</span>)</span>
<span id="cb21-532"><a href="#cb21-532" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"RStata.StataPath"</span><span class="ot">=</span> <span class="st">'/Applications/Stata/StataMP.app/Contents/MacOS/stata-mp'</span>)</span>
<span id="cb21-533"><a href="#cb21-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-534"><a href="#cb21-534" aria-hidden="true" tabindex="-1"></a>s_twfe <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb21-535"><a href="#cb21-535" aria-hidden="true" tabindex="-1"></a><span class="st">qui xtreg y i.treat i.year, i(state) fe vce(cluster state) cformat(%4.3f)</span></span>
<span id="cb21-536"><a href="#cb21-536" aria-hidden="true" tabindex="-1"></a><span class="st">estimates store xttwfe</span></span>
<span id="cb21-537"><a href="#cb21-537" aria-hidden="true" tabindex="-1"></a><span class="st">estimates table xttwfe, b se keep(1.treat)</span></span>
<span id="cb21-538"><a href="#cb21-538" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb21-539"><a href="#cb21-539" aria-hidden="true" tabindex="-1"></a><span class="fu">stata</span>(s_twfe, <span class="at">data.in=</span>d)</span>
<span id="cb21-540"><a href="#cb21-540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-541"><a href="#cb21-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-542"><a href="#cb21-542" aria-hidden="true" tabindex="-1"></a>Okay so, basically the same. Now let's run the extended TWFE model. In order to make estimating the marginal effects for aggregate ATTs a bit easier, we use the Wooldridge specification that interacts the time-varying treatment indicator with both the cohort and time dummies. This is done 'by hand' using product terms between the treatment indicator (<span class="in">`treat`</span>), cohort indicators (<span class="in">`gXXXX`</span>) and year indicators (<span class="in">`yXXXX`</span>), for example <span class="in">`c.treat#c.g2014#c.y2014`</span> and so on for each of the required product terms.  </span>
<span id="cb21-543"><a href="#cb21-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-544"><a href="#cb21-544" aria-hidden="true" tabindex="-1"></a>To estimate the marginal effects is pretty straightforward, largely accomplished by using the <span class="in">`dydx(treat)`</span> on the treated subpopulation (i.e, <span class="in">`subpop(treat=1)`</span>) and then aggregating over various dimensions (event, cohorts, years, etc.)</span>
<span id="cb21-545"><a href="#cb21-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-546"><a href="#cb21-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r st_etwfe}</span></span>
<span id="cb21-547"><a href="#cb21-547" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new dataset for Stata analysis</span></span>
<span id="cb21-548"><a href="#cb21-548" aria-hidden="true" tabindex="-1"></a>dstata <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb21-549"><a href="#cb21-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y2014 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2014</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-550"><a href="#cb21-550" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2015 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2015</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-551"><a href="#cb21-551" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2016 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-552"><a href="#cb21-552" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2017 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2017</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-553"><a href="#cb21-553" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2018 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2018</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-554"><a href="#cb21-554" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2019 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2019</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-555"><a href="#cb21-555" aria-hidden="true" tabindex="-1"></a>         <span class="at">y2020 =</span> <span class="fu">if_else</span>(year<span class="sc">==</span><span class="dv">2020</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-556"><a href="#cb21-556" aria-hidden="true" tabindex="-1"></a>         <span class="at">g2014 =</span> <span class="fu">if_else</span>(cohort_year <span class="sc">==</span> <span class="dv">2014</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-557"><a href="#cb21-557" aria-hidden="true" tabindex="-1"></a>         <span class="at">g2016 =</span> <span class="fu">if_else</span>(cohort_year <span class="sc">==</span> <span class="dv">2016</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb21-558"><a href="#cb21-558" aria-hidden="true" tabindex="-1"></a>         <span class="at">event =</span> year <span class="sc">-</span> cohort_year)</span>
<span id="cb21-559"><a href="#cb21-559" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-560"><a href="#cb21-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-561"><a href="#cb21-561" aria-hidden="true" tabindex="-1"></a>s_etwfe <span class="ot">&lt;-</span> <span class="st">'</span></span>
<span id="cb21-562"><a href="#cb21-562" aria-hidden="true" tabindex="-1"></a><span class="st">qui xtreg y c.treat#c.g2014#c.y2014 c.treat#c.g2014#c.y2015 ///</span></span>
<span id="cb21-563"><a href="#cb21-563" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2016 c.treat#c.g2014#c.y2017 ///</span></span>
<span id="cb21-564"><a href="#cb21-564" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2018 c.treat#c.g2014#c.y2019 ///</span></span>
<span id="cb21-565"><a href="#cb21-565" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2014#c.y2020 c.treat#c.g2016#c.y2016 ///</span></span>
<span id="cb21-566"><a href="#cb21-566" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2016#c.y2017 c.treat#c.g2016#c.y2018 ///</span></span>
<span id="cb21-567"><a href="#cb21-567" aria-hidden="true" tabindex="-1"></a><span class="st">        c.treat#c.g2016#c.y2019 c.treat#c.g2016#c.y2020 ///</span></span>
<span id="cb21-568"><a href="#cb21-568" aria-hidden="true" tabindex="-1"></a><span class="st">        y2014 y2015 y2016 y2017 y2018 y2019 y2020, ///</span></span>
<span id="cb21-569"><a href="#cb21-569" aria-hidden="true" tabindex="-1"></a><span class="st">        i(state) fe vce(cluster state) cformat(%4.3f)</span></span>
<span id="cb21-570"><a href="#cb21-570" aria-hidden="true" tabindex="-1"></a><span class="st">estimates store etwfe</span></span>
<span id="cb21-571"><a href="#cb21-571" aria-hidden="true" tabindex="-1"></a><span class="st">esttab etwfe, b se keep(c.treat#*) nostar nonotes varwidth(25)</span></span>
<span id="cb21-572"><a href="#cb21-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-573"><a href="#cb21-573" aria-hidden="true" tabindex="-1"></a><span class="st">* aggregate ATTs</span></span>
<span id="cb21-574"><a href="#cb21-574" aria-hidden="true" tabindex="-1"></a><span class="st">* simple</span></span>
<span id="cb21-575"><a href="#cb21-575" aria-hidden="true" tabindex="-1"></a><span class="st">margins, dydx(treat) subpop(if treat==1)</span></span>
<span id="cb21-576"><a href="#cb21-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-577"><a href="#cb21-577" aria-hidden="true" tabindex="-1"></a><span class="st">* group effects</span></span>
<span id="cb21-578"><a href="#cb21-578" aria-hidden="true" tabindex="-1"></a><span class="st">margins, subpop(if treat==1) dydx(treat) over(cohort_year)</span></span>
<span id="cb21-579"><a href="#cb21-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-580"><a href="#cb21-580" aria-hidden="true" tabindex="-1"></a><span class="st">* calendar effects</span></span>
<span id="cb21-581"><a href="#cb21-581" aria-hidden="true" tabindex="-1"></a><span class="st">margins, subpop(if treat==1) dydx(treat) over(year)</span></span>
<span id="cb21-582"><a href="#cb21-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-583"><a href="#cb21-583" aria-hidden="true" tabindex="-1"></a><span class="st">* dynamic effects</span></span>
<span id="cb21-584"><a href="#cb21-584" aria-hidden="true" tabindex="-1"></a><span class="st">margins, dydx(treat) subpop(if treat==1)  over(event)</span></span>
<span id="cb21-585"><a href="#cb21-585" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb21-586"><a href="#cb21-586" aria-hidden="true" tabindex="-1"></a><span class="fu">stata</span>(s_etwfe, <span class="at">data.in=</span>dstata)</span>
<span id="cb21-587"><a href="#cb21-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-588"><a href="#cb21-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-589"><a href="#cb21-589" aria-hidden="true" tabindex="-1"></a>From these models it seems like the basic estimates for the aggregate ATTs are pretty similar for ETWFE and CS implementations. </span>
<span id="cb21-590"><a href="#cb21-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-591"><a href="#cb21-591" aria-hidden="true" tabindex="-1"></a>Need to add: covariates.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>